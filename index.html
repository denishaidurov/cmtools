<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CM Tools</title>
    <style>
        :root {
            /* --- –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê --- */
            --bg-body: #0f172a;       
            --bg-card: #1e293b;       
            --input-bg: #334155;      
            --text-main: #f1f5f9;     
            --text-muted: #94a3b8;    
            --border-color: #475569;
            
            /* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –∏ —Ü–≤–µ—Ç–∞ */
            --brand-gradient: linear-gradient(135deg, #ec4899 0%, #eab308 100%); 
            --brand-gradient-hover: linear-gradient(135deg, #f06292 0%, #ffca28 100%); 
            --brand-glow: rgba(236, 72, 153, 0.4);
            --success-color: #10b981;
            --danger-color: #ef4444;
            --accent-bg: rgba(236, 72, 153, 0.05);

            /* –§–æ–Ω –¥–ª—è –∫–æ–¥–∞ */
            --code-bg-light: #1a2333;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 40px 20px;
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: var(--bg-card);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 40px;
            position: relative;
            overflow: visible; 
            
            transition: max-width 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .container.wide { max-width: 1050px; }

        .container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 6px;
            background: var(--brand-gradient);
            border-radius: 24px 24px 0 0;
        }

        /* --- –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ --- */
        .mode-switcher-container { display: flex; justify-content: center; margin-bottom: 30px; }
        .mode-switcher { background-color: var(--input-bg); padding: 5px; border-radius: 50px; display: flex; gap: 5px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .mode-switcher input[type="radio"] { display: none; }
        .mode-switcher label { padding: 10px 35px; border-radius: 40px; cursor: pointer; font-size: 0.95rem; font-weight: 600; color: var(--text-muted); transition: all 0.3s ease; margin-bottom: 0; user-select: none; }
        .mode-switcher input[type="radio"]:checked + label { background: var(--brand-gradient); color: white; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3); }

        /* --- –°–ï–ö–¶–ò–ò --- */
        .section-content { display: none; animation: fadeInSection 0.4s ease; }
        .section-content.active { display: block; }
        @keyframes fadeInSection { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† --- */
        .calc-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-color);
            border-radius: 20px; position: relative;
        }
        .calc-grid::before {
            content: ''; position: absolute; top: 30px; bottom: 30px; left: 50%; width: 1px; background: var(--border-color); transform: translateX(-50%); z-index: 1; opacity: 0.5;
        }
        .calc-grid::after {
            content: '‚Üí'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 36px; height: 36px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #ec4899; font-weight: 800; font-size: 1.2rem; z-index: 2; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .calc-card { padding: 35px; border: none; background: transparent; }
        .card-header { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; color: var(--text-muted); margin-bottom: 25px; display: flex; align-items: center; gap: 10px; opacity: 0.9; }
        .calc-card.target .card-header { color: #ec4899; opacity: 1; }

        @media (max-width: 850px) {
            .calc-grid { grid-template-columns: 1fr; }
            .calc-grid::before { top: 50%; left: 30px; right: 30px; width: auto; height: 1px; transform: translateY(-50%); }
            .calc-grid::after { content: '‚Üì'; }
        }

        .input-group { margin-bottom: 20px; position: relative; }
        
        label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

        input, select, textarea { width: 100%; background-color: var(--input-bg); border: 1px solid transparent; color: var(--text-main); padding: 16px 18px; border-radius: 12px; font-size: 0.95rem; box-sizing: border-box; font-family: inherit; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; background-color: #1e293b; border-color: #ec4899; box-shadow: 0 0 0 3px var(--brand-glow); }

        /* –£–±–∏—Ä–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä—ã */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; background-size: 18px; padding-right: 40px; cursor: pointer; }

        .fade-in { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –ù–û–í–´–ô –î–í–£–•–ü–ê–ù–ï–õ–¨–ù–´–ô POPUP --- */
        .custom-popup {
            position: absolute; top: 100%; right: 0; left: 0;
            background: #1e293b; border: 1px solid var(--border-color);
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            z-index: 100; margin-top: 8px;
            height: 320px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
            display: none; 
            flex-direction: row; /* –î–≤–µ –∫–æ–ª–æ–Ω–∫–∏ */
            overflow: hidden;
        }
        
        .custom-popup.open { display: flex; animation: popupEnter 0.2s ease forwards; }
        @keyframes popupEnter { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–ö—É—Ä—Å—ã) */
        .popup-pane-left {
            width: 50%;
            overflow-y: auto;
            border-right: 1px solid rgba(255,255,255,0.05);
            background: #1e293b;
        }

        /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–¢–∞—Ä–∏—Ñ—ã) */
        .popup-pane-right {
            width: 50%;
            overflow-y: auto;
            background: rgba(0,0,0,0.2); /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ */
        }

        .popup-item {
            padding: 12px 15px;
            font-size: 0.85rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.02);
            transition: all 0.1s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .popup-item:hover, .popup-item.active {
            background: rgba(236, 72, 153, 0.1);
            color: #ec4899;
        }

        /* –°—Ç—Ä–µ–ª–æ—á–∫–∞ –Ω–∞ –∫—É—Ä—Å–µ, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –µ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å */
        .item-arrow { font-size: 0.7rem; opacity: 0.5; }

        .tariff-item {
            padding: 12px 15px;
            font-size: 0.8rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.02);
            color: #cbd5e1;
        }
        .tariff-item:hover { background: #ec4899; color: white; }
        
        .tariff-placeholder {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-style: italic;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* --- DASHBOARD --- */
        .dashboard-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 40px; margin-bottom: 30px; }
        .stat-box { background: var(--input-bg); padding: 20px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px; font-weight: 700; }
        .stat-value { font-size: 1.4rem; font-weight: 800; color: var(--text-main); }
        .stat-value.burned { color: #ef4444; }
        .stat-value.residue { color: #10b981; }
        .stat-value.total { color: #ec4899; font-size: 1.8rem; }

        .progress-container { margin-bottom: 30px; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; }
        .progress-track { height: 10px; background: #334155; border-radius: 5px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 100%); width: 0%; transition: width 0.5s ease; }

        .actions { display: flex; gap: 15px; margin-top: 30px; }
        button { flex: 1; padding: 20px; border: none; border-radius: 14px; color: white; font-weight: 700; font-size: 1rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(0,0,0,0.4); }
        button:active { transform: scale(0.98); }
        #generate-button { background: var(--brand-gradient); }
        #generate-button:hover { background: var(--brand-gradient-hover); }
        #copy-button, #calc-copy-button { background-color: #334155; border: 1px solid var(--success-color); color: var(--success-color); }
        #copy-button:hover, #calc-copy-button:hover { background-color: var(--success-color); color: white; }

        .result-box { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 30px; display: none; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; }
        .result-box.is-visible { display: block; animation: resultEntry 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .result-box.calc-visible { display: block; opacity: 1; transform: none; margin-top: 20px; padding-top: 20px; border: none; }
        @keyframes resultEntry { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .result-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; color: var(--text-main); font-size: 0.95rem; font-weight: 700; }
        textarea { font-family: 'Consolas', 'Monaco', monospace; background-color: var(--code-bg-light); color: #e2e8f0; border: 1px solid var(--border-color); line-height: 1.6; resize: vertical; min-height: 80px; width: 100%; padding: 20px; border-radius: 12px; box-sizing: border-box; font-size: 0.9rem; overflow-y: hidden; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .label-row label { margin-bottom: 0; }
        .sales-book-link { font-size: 0.7rem; color: #ec4899; text-decoration: none; border: 1px solid #ec4899; padding: 3px 10px; border-radius: 8px; font-weight: 700; text-transform: uppercase; transition: all 0.2s; background: rgba(236, 72, 153, 0.05); }
        .sales-book-link:hover { background: #ec4899; color: white; }
    </style>
</head>
<body>

<div class="container"> 
    <div class="mode-switcher-container">
        <div class="mode-switcher">
            <input type="radio" id="mode-welcome" name="app-mode" value="welcome" checked>
            <label for="mode-welcome">Welcome</label>
            <input type="radio" id="mode-calculator" name="app-mode" value="calculator">
            <label for="mode-calculator">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</label>
        </div>
    </div>

    <div id="section-welcome" class="section-content active">
        <form id="welcome-form" class="grid-layout" style="display:grid; gap:20px;">
            <div class="input-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</label>
                <select id="course-select" required>
                    <option value="" disabled selected>–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                    <option value="Digital-–¥–∏–∑–∞–π–Ω–µ—Ä –Ω–æ–≤–æ–π —ç—Ä—ã 3.0">Digital-–¥–∏–∑–∞–π–Ω–µ—Ä –Ω–æ–≤–æ–π —ç—Ä—ã 3.0</option>
                    <option value="Digital-–¥–∏–∑–∞–π–Ω–µ—Ä 2.0">Digital-–¥–∏–∑–∞–π–Ω–µ—Ä 2.0</option>
                    <option value="NEW 3.0 –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω">NEW 3.0 –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω</option>
                    <option value="NEW –ü—Ä–æ—Ñ–µ—Å—Å–∏—è UX/UI-–¥–∏–∑–∞–π–Ω–µ—Ä">NEW –ü—Ä–æ—Ñ–µ—Å—Å–∏—è UX/UI-–¥–∏–∑–∞–π–Ω–µ—Ä</option>
                    <option value="–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ç–æ—Ä 2.0">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ç–æ—Ä 2.0</option>
                    <option value="–í–µ–±-–¥–∏–∑–∞–π–Ω–µ—Ä 2.0">–í–µ–±-–¥–∏–∑–∞–π–Ω–µ—Ä 2.0</option>
                    <option value="–ù–µ–π—Ä–æ–¥–∏–∑–∞–π–Ω–µ—Ä 2.0">–ù–µ–π—Ä–æ–¥–∏–∑–∞–π–Ω–µ—Ä 2.0</option>
                    <option value="Motion-–¥–∏–∑–∞–π–Ω–µ—Ä">Motion-–¥–∏–∑–∞–π–Ω–µ—Ä</option>
                    <option value="NEW –î–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤">NEW –î–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤</option>
                    <option value="–î–∏–∑–∞–π–Ω —É–ø–∞–∫–æ–≤–∫–∏">–î–∏–∑–∞–π–Ω —É–ø–∞–∫–æ–≤–∫–∏</option>
                </select>
            </div>
            <div class="input-group fade-in" id="tariff-container" style="display:none;">
                <label>–¢–∞—Ä–∏—Ñ –æ–±—É—á–µ–Ω–∏—è</label>
                <select id="tariff-select"></select>
            </div>
            <div class="input-group">
                <label>–î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞</label>
                <input type="date" id="start-date" required>
            </div>
            <div class="actions">
                <button type="submit" id="generate-button"><span>‚ö° –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</span></button>
                <button type="button" id="copy-button" onclick="copyToClipboard('result-template', 'copy-button')" style="display:none;"><span>üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span></button>
            </div>
        </form>
        <div class="result-box" id="result-box-welcome">
            <div class="result-header">
                <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" color="#ec4899">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <strong>–ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç</strong>
            </div>
            <textarea id="result-template" readonly placeholder="// –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç..."></textarea>
        </div>
    </div>

    <div id="section-calculator" class="section-content">
        <form id="calculator-form">
            <div class="calc-grid">
                <div class="calc-card source">
                    <div class="card-header">–¢–µ–∫—É—â–µ–µ –æ–±—É—á–µ–Ω–∏–µ</div>
                    
                    <div style="display:none;">
                        <select id="calc-source-course"><option value="" selected>Manual</option></select>
                        <select id="calc-source-tariff"></select>
                    </div>

                    <div class="input-group" style="position:relative;">
                        <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–µ—Å)</label>
                        <input type="number" id="calc-duration-months" value="12" required placeholder="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫—É—Ä—Å–∞...">
                        
                        <div id="calc-popup" class="custom-popup">
                            <div class="popup-pane-left" id="popup-courses">
                                </div>
                            <div class="popup-pane-right" id="popup-tariffs">
                                <div class="tariff-placeholder">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å —Å–ª–µ–≤–∞...</div>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>–û–ø–ª–∞—á–µ–Ω–æ (—Ä—É–±)</label>
                        <input type="number" id="calc-paid" placeholder="0" required>
                    </div>
                    <div class="input-group">
                        <label>–î–∞—Ç–∞ —Å—Ç–∞—Ä—Ç–∞</label>
                        <input type="date" id="calc-start-date" required>
                    </div>
                    <div class="input-group">
                        <label>–î–∞—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è</label>
                        <input type="date" id="calc-request-date" required>
                    </div>
                </div>

                <div class="calc-card target">
                    <div class="card-header">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞</div>
                    <div class="input-group">
                        <label>–ù–æ–≤—ã–π –∫—É—Ä—Å</label>
                        <select id="calc-new-course-name" required>
                            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            <option value="manual">‚úçÔ∏è –í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</option>
                            <option value="Digital-–¥–∏–∑–∞–π–Ω–µ—Ä –Ω–æ–≤–æ–π —ç—Ä—ã 3.0">Digital-–¥–∏–∑–∞–π–Ω–µ—Ä –Ω–æ–≤–æ–π —ç—Ä—ã 3.0</option>
                            <option value="Digital-–¥–∏–∑–∞–π–Ω–µ—Ä 2.0">Digital-–¥–∏–∑–∞–π–Ω–µ—Ä 2.0</option>
                            <option value="NEW 3.0 –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω">NEW 3.0 –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω</option>
                            <option value="NEW –ü—Ä–æ—Ñ–µ—Å—Å–∏—è UX/UI-–¥–∏–∑–∞–π–Ω–µ—Ä">NEW –ü—Ä–æ—Ñ–µ—Å—Å–∏—è UX/UI-–¥–∏–∑–∞–π–Ω–µ—Ä</option>
                            <option value="–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ç–æ—Ä 2.0">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ç–æ—Ä 2.0</option>
                            <option value="–í–µ–±-–¥–∏–∑–∞–π–Ω–µ—Ä 2.0">–í–µ–±-–¥–∏–∑–∞–π–Ω–µ—Ä 2.0</option>
                            <option value="–ù–µ–π—Ä–æ–¥–∏–∑–∞–π–Ω–µ—Ä 2.0">–ù–µ–π—Ä–æ–¥–∏–∑–∞–π–Ω–µ—Ä 2.0</option>
                            <option value="Motion-–¥–∏–∑–∞–π–Ω–µ—Ä">Motion-–¥–∏–∑–∞–π–Ω–µ—Ä</option>
                            <option value="NEW –î–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤">NEW –î–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤</option>
                            <option value="–î–∏–∑–∞–π–Ω —É–ø–∞–∫–æ–≤–∫–∏">–î–∏–∑–∞–π–Ω —É–ø–∞–∫–æ–≤–∫–∏</option>
                        </select>
                        <input type="text" id="calc-new-course-manual" class="fade-in" style="display:none; margin-top:10px;" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞">
                    </div>
                    <div class="input-group fade-in" id="calc-new-tariff-container" style="display:none;">
                        <label>–¢–∞—Ä–∏—Ñ –Ω–æ–≤–æ–≥–æ –∫—É—Ä—Å–∞</label>
                        <select id="calc-new-tariff"></select>
                    </div>
                    <div class="input-group">
                        <div class="label-row">
                            <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–æ–≤–æ–≥–æ (—Ä—É–±)</label>
                            <a href="https://docs.google.com/spreadsheets/d/1tGX-WJlBGYzmaci4Tb19goY_AQzbHnk3xZJ-pbXyLRs/edit?gid=1976664245#gid=1976664245" target="_blank" class="sales-book-link">üìñ –ö–Ω–∏–≥–∞ –ø—Ä–æ–¥–∞–∂</a>
                        </div>
                        <input type="number" id="calc-new-cost" placeholder="0" required>
                    </div>
                    <div class="input-group">
                        <label>–°–∫–∏–¥–∫–∞ (%)</label>
                        <input type="number" id="calc-discount" min="0" max="100" value="20">
                    </div>
                </div>
            </div>

            <div class="dashboard-stats">
                <div class="stat-box"><div class="stat-label">–°–≥–æ—Ä–µ–ª–æ (–ø—Ä–æ–π–¥–µ–Ω–æ)</div><div class="stat-value burned" id="stat-consumed">-</div></div>
                <div class="stat-box"><div class="stat-label">–û—Å—Ç–∞—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤</div><div class="stat-value residue" id="stat-residue">-</div></div>
                <div class="stat-box"><div class="stat-label">–ò—Ç–æ–≥–æ –∫ –¥–æ–ø–ª–∞—Ç–µ</div><div class="stat-value total" id="stat-topay">-</div></div>
            </div>
            <div class="progress-container">
                <div class="progress-labels"><span id="prog-days-studied">0 –¥–Ω–µ–π</span><span id="prog-days-total">–í—Å–µ–≥–æ 0 –¥–Ω–µ–π</span></div>
                <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
            </div>
            <div class="result-box calc-visible" id="result-box-calc">
                <div class="result-header"><strong>–¢–µ–∫—Å—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞</strong></div>
                <textarea id="result-text-calc" readonly placeholder="–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è..."></textarea>
            </div>
            <div class="actions">
                <button type="button" id="calc-copy-button" onclick="copyToClipboard('result-text-calc', 'calc-copy-button')"><span>üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</span></button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- –ö–û–ù–§–ò–ì ---
    const COURSE_CONFIG = {
        'Digital-–¥–∏–∑–∞–π–Ω–µ—Ä –Ω–æ–≤–æ–π —ç—Ä—ã 3.0': { templateType: 'Standard', streamTime: '19:00', defaultTariff: '–ë–∞–∑–æ–≤—ã–π', tariffs: { '–ë–∞–∑–æ–≤—ã–π': { months: 12, chat: 'https://t.me/+qn70Xd6J9aw4ZTVi', customAccess: '–Ω–∞ 18 –º–µ—Å—è—Ü–µ–≤' }, '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π': { months: 14, chat: 'https://t.me/+qn70Xd6J9aw4ZTVi', customAccess: '–Ω–∞–≤—Å–µ–≥–¥–∞' } }, anketa: 'https://docs.google.com/forms/d/e/1FAIpQLSfS9IitnBvCEi7HjgBYbhoCS2MijKA_y3slFu6fRnJJ7Y7DWA/viewform', curatorDZ: '–ú–∞—Ä–∏–Ω–∞ –ò–ª—å–µ–Ω–∫–æ', accessYears: 3 },
        '–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –∏–ª–ª—é—Å—Ç—Ä–∞—Ç–æ—Ä 2.0': { templateType: 'Standard', streamTime: '19:00', defaultTariff: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π', tariffs: { '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π': { months: 9, chat: 'https://t.me/+KVHDByLijP8zYmJi' }, '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π': { months: 13, chat: 'https://t.me/+KVHDByLijP8zYmJi' }, '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π': { months: 17, chat: 'https://t.me/+KVHDByLijP8zYmJi' } }, anketa: 'https://docs.google.com/forms/d/e/1FAIpQLSfS9IitnBvCEi7HjgBYbhoCS2MijKA_y3slFu6fRnJJ7Y7DWA/viewform', accessYears: 3, noStream: true },
        '–í–µ–±-–¥–∏–∑–∞–π–Ω–µ—Ä 2.0': { templateType: 'Standard', streamTime: '19:00', defaultTariff: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π', tariffs: { '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π': { months: 12, chat: 'https://t.me/+PG30jTVyFUNiYjQy' }, '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π': { months: 14, chat: 'https://t.me/+PG30jTVyFUNiYjQy' } }, anketa: 'https://docs.google.com/forms/d/e/1FAIpQLSfS9IitnBvCEi7HjgBYbhoCS2MijKA_y3slFu6fRnJJ7Y7DWA/viewform', accessYears: 3, noStream: true },
        'Motion-–¥–∏–∑–∞–π–Ω–µ—Ä': { templateType: 'Standard', streamTime: '19:00', tariffs: null, chatLink: 'https://t.me/+LBfKLbM3B8Y2MWQy', months: 12, accessYears: 3, curatorDZ: '–ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–∞—É–º–æ–≤–∞', anketa: 'https://docs.google.com/forms/d/e/1FAIpQLSfS9IitnBvCEi7HjgBYbhoCS2MijKA_y3slFu6fRnJJ7Y7DWA/viewform', isMotion: true, noStream: true },
        'Digital-–¥–∏–∑–∞–π–Ω–µ—Ä 2.0': { templateType: 'Standard', streamTime: '19:00', defaultTariff: '–•–æ—á—É –≤—Å–µ –∏ —Å—Ä–∞–∑—É', tariffs: { '–•–æ—á—É –Ω–∞ —Ñ—Ä–∏–ª–∞–Ω—Å': { months: 6, chat: 'https://t.me/+qn70Xd6J9aw4ZTVi' }, '–•–æ—á—É —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ': { months: 9, chat: 'https://t.me/+qn70Xd6J9aw4ZTVi' }, '–•–æ—á—É –≤—Å–µ –∏ —Å—Ä–∞–∑—É': { months: 12, chat: 'https://t.me/+qn70Xd6J9aw4ZTVi' } }, anketa: 'https://docs.google.com/forms/d/e/1FAIpQLSfS9IitnBvCEi7HjgBYbhoCS2MijKA_y3slFu6fRnJJ7Y7DWA/viewform', curatorDZ: '–ú–∞—Ä–∏–Ω–∞ –ò–ª—å–µ–Ω–∫–æ', accessYears: 3 },
        'NEW 3.0 –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω': { templateType: 'Standard', streamTime: '18:00', defaultTariff: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π', tariffs: { '1 —Å—Ç—É–ø–µ–Ω—å': { months: 4, chat: 'https://t.me/+algT3-99H18yOWEy', customAccess: '–Ω–∞ 6 –º–µ—Å—è—Ü–µ–≤' }, '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π': { months: 7, chat: 'https://t.me/+algT3-99H18yOWEy' }, '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π': { months: 12, chat: 'https://t.me/+algT3-99H18yOWEy' }, '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π': { months: 15, chat: 'https://t.me/+algT3-99H18yOWEy' } }, anketa: 'https://docs.google.com/forms/d/e/1FAIpQLSfS9IitnBvCEi7HjgBYbhoCS2MijKA_y3slFu6fRnJJ7Y7DWA/viewform', curatorDZ: '–ú–∞—Ä–∏–Ω–∞ –ò–ª—å–µ–Ω–∫–æ', accessYears: 3 },
        'NEW –ü—Ä–æ—Ñ–µ—Å—Å–∏—è UX/UI-–¥–∏–∑–∞–π–Ω–µ—Ä': { templateType: 'Standard', streamTime: '19:00', defaultTariff: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π', tariffs: { '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π': { months: 13, chat: 'https://t.me/+PG30jTVyFUNiYjQy' }, '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π': { months: 16, chat: 'https://t.me/+PG30jTVyFUNiYjQy' } }, anketa: 'https://docs.google.com/forms/d/e/1FAIpQLSfS9IitnBvCEi7HjgBYbhoCS2MijKA_y3slFu6fRnJJ7Y7DWA/viewform', curatorDZ: '–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞ –ö–∞–º–µ–Ω—Å–∫–∞—è', accessYears: 3, noStream: true },
        '–ù–µ–π—Ä–æ–¥–∏–∑–∞–π–Ω–µ—Ä 2.0': { templateType: 'NeuroDesign', months: 3, accessYears: 1, chatLink: 'https://t.me/+RyvUSRyw_T9jMDZi', noStream: true },
        'NEW –î–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤': { templateType: 'Marketplace', defaultTariff: '—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π', tariffs: { '—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π': { months: 2, accessYears: 1, chat: 'https://t.me/+2RfHq_VV1f0wMThi', curator: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ì–æ–≥–ª–∞—á–µ–≤' }, '–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏': { months: 2, accessYears: 1, chat: 'https://t.me/+2RfHq_VV1f0wMThi', curator: null } }, anketa: 'https://docs.google.com/forms/d/e/1FAIpQLSfS9IitnBvCEi7HjgBYbhoCS2MijKA_y3slFu6fRnJJ7Y7DWA/viewform', accessYears: 1 },
        '–î–∏–∑–∞–π–Ω —É–ø–∞–∫–æ–≤–∫–∏': { templateType: 'Packaging', months: 3, accessYears: 1, noStream: true }
    };

    // --- UI/LOGIC ---
    const radios = document.getElementsByName('app-mode');
    const sections = { welcome: document.getElementById('section-welcome'), calculator: document.getElementById('section-calculator') };
    const container = document.querySelector('.container');
    
    radios.forEach(radio => radio.addEventListener('change', (e) => {
        const mode = e.target.value;
        Object.values(sections).forEach(el => el.classList.remove('active'));
        sections[mode].classList.add('active');
        if (mode === 'welcome') container.classList.remove('wide');
        else container.classList.add('wide');
    }));

    // --- POPUP LOGIC (2-PANE) ---
    const popupInput = document.getElementById('calc-duration-months');
    const popup = document.getElementById('calc-popup');
    const popupCourses = document.getElementById('popup-courses');
    const popupTariffs = document.getElementById('popup-tariffs');
    
    // Open on click
    popupInput.addEventListener('click', (e) => {
        e.stopPropagation();
        openTwoPanePopup();
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
        if (!popup.contains(e.target) && e.target !== popupInput) {
            popup.classList.remove('open');
        }
    });

    function openTwoPanePopup() {
        popupCourses.innerHTML = '';
        popupTariffs.innerHTML = '<div class="tariff-placeholder">–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ –∫—É—Ä—Å —Å–ª–µ–≤–∞...</div>';
        
        Object.keys(COURSE_CONFIG).forEach(courseKey => {
            const div = document.createElement('div');
            div.className = 'popup-item';
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–∞—Ä–∏—Ñ—ã - –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–æ—á–∫—É
            const hasTariffs = !!COURSE_CONFIG[courseKey].tariffs;
            div.innerHTML = `${courseKey} ${hasTariffs ? '<span class="item-arrow">‚ñ∂</span>' : ''}`;
            
            div.onmouseenter = () => showTariffsForCourse(courseKey);
            // –ï—Å–ª–∏ —Ç–∞—Ä–∏—Ñ–æ–≤ –Ω–µ—Ç - –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Å—Ä–∞–∑—É –ø–æ –∫–ª–∏–∫—É
            if(!hasTariffs) {
                div.onclick = () => applySelection(courseKey, null, COURSE_CONFIG[courseKey].months);
            }
            
            popupCourses.appendChild(div);
        });
        
        popup.classList.add('open');
    }

    function showTariffsForCourse(courseKey) {
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ
        const items = popupCourses.querySelectorAll('.popup-item');
        items.forEach(i => i.classList.remove('active'));
        // –ù–∞–π—Ç–∏ —Ç–µ–∫—É—â–∏–π —ç–ª–µ–º–µ–Ω—Ç (—á–µ—Ä–µ–∑ event target —Å–ª–æ–∂–Ω–æ, –ø—Ä–æ—â–µ —Ç–∞–∫)
        // ... (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, hover css —Ä–∞–±–æ—Ç–∞–µ—Ç)

        const config = COURSE_CONFIG[courseKey];
        popupTariffs.innerHTML = '';

        if (config.tariffs) {
            Object.keys(config.tariffs).forEach(tariffName => {
                const t = config.tariffs[tariffName];
                const div = document.createElement('div');
                div.className = 'tariff-item';
                div.textContent = `${tariffName} (${t.months} –º–µ—Å)`;
                div.onclick = (e) => {
                    e.stopPropagation();
                    applySelection(courseKey, tariffName, t.months);
                };
                popupTariffs.appendChild(div);
            });
        } else {
            // –ï—Å–ª–∏ —Ç–∞—Ä–∏—Ñ–æ–≤ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞
            const div = document.createElement('div');
            div.className = 'tariff-item';
            div.textContent = `–°—Ç–∞–Ω–¥–∞—Ä—Ç (${config.months} –º–µ—Å)`;
            div.onclick = (e) => {
                e.stopPropagation();
                applySelection(courseKey, null, config.months);
            };
            popupTariffs.appendChild(div);
        }
    }

    function applySelection(course, tariff, months) {
        document.getElementById('calc-duration-months').value = months;
        document.getElementById('calc-source-course').value = course;
        calculateLive();
        popup.classList.remove('open');
    }

    // --- COPY & RESIZE ---
    async function copyToClipboard(id, btnId) {
        const el = document.getElementById(id);
        const btn = document.getElementById(btnId);
        if(!el.value) return;
        try {
            await navigator.clipboard.writeText(el.value);
            const original = btn.innerHTML;
            btn.innerHTML = '<span>‚úÖ –ì–æ—Ç–æ–≤–æ!</span>';
            setTimeout(() => btn.innerHTML = original, 2000);
        } catch(e) { console.error(e); }
    }
    function autoResize(el) {
        el.style.height = 'auto';
        setTimeout(() => el.style.height = (el.scrollHeight + 5) + 'px', 10);
    }

    // --- WELCOME GENERATOR & HELPERS ---
    const getGreetingTime = () => { const h=new Date().getHours(); return (h>=5&&h<12)?"–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ":(h>=12&&h<18)?"–î–æ–±—Ä—ã–π –¥–µ–Ω—å":"–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä"; };
    const isInvalidDate = (d) => d instanceof Date && isNaN(d.getTime());
    const formatDateDDMMYYYY = (d) => { if(isInvalidDate(d)) return '...'; const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), y=d.getFullYear(); return `${dd}.${mm}.${y}`; };
    const formatDateFull = (d) => { if(isInvalidDate(d)) return '...'; return d.toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'}).replace(/(\s–≥\.)?$/, ' –≥.'); };
    const formatDateStream = (d) => { if(isInvalidDate(d)) return '...'; return d.toLocaleDateString('ru-RU',{day:'numeric',month:'long'}); };
    const getMonthText = (n) => (n===1)?'–º–µ—Å—è—Ü':(n>=2&&n<=4)?'–º–µ—Å—è—Ü–∞':'–º–µ—Å—è—Ü–µ–≤';
    function calculateEndDate(s, m) { if(isInvalidDate(s)) return new Date(); const d=new Date(s); d.setMonth(d.getMonth()+m); if(d.getDate()<s.getDate()) d.setDate(0); return d; }

    const COMMON_TEXT = {
        greeting: (time) => `${time}ü©∑ –ù–∞ —Å–≤—è–∑–∏ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–±–æ—Ç—ã –æ—Ç —à–∫–æ–ª—ã –õ–æ–≥–æ–º–∞—à–∏–Ω–∞ —É—á–∏—Ç üíõ –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—É—á–µ–Ω–∏—è –º–æ–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–∞–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ–º —Å 10:00 –¥–æ 22:00 –ø–æ –º—Å–∫\n\n–ú—ã –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –≤–∞—Å –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥—É –æ–±—É—á–µ–Ω–∏—è. –í —ç—Ç–æ–π —à–∫–æ–ª–µ –≤—ã –≤—Å–µ–≥–¥–∞ –Ω–∞–π–¥–µ—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É, –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏, –∫–æ–Ω–µ—á–Ω–æ, –º–Ω–æ–≥–æ –Ω–æ–≤—ã—Ö –¥—Ä—É–∑–µ–π. –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –∫–∞–∫–∏–µ-–ª–∏–±–æ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞—Ö–æ—á–µ—Ç—Å—è –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å, –º—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç—ã –¥–ª—è –≤–∞—Å.`,
        introBlockPast: `üñá–í—Å–µ –±–ª–æ–∫–∏ –∫—É—Ä—Å–∞, –≤–∫–ª—é—á–∞—è –≤–≤–æ–¥–Ω—ã–π –±–ª–æ–∫ "–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –∫—É—Ä—Å –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–π", —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è. –í–≤–æ–¥–Ω—ã–π –±–ª–æ–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–û–±—É—á–µ–Ω–∏–µ" ‚Äî "–¢—Ä–µ–Ω–∏–Ω–≥–∏", —Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π –≤ —Å–ø–∏—Å–∫–µ.`,
        introBlockFuture: (date) => `üñá–û–±—É—á–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ–º —Å –∏–∑—É—á–µ–Ω–∏—è –±–ª–æ–∫–∞ "–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –∫—É—Ä—Å –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–π", —ç—Ç–æ –≤–≤–æ–¥–Ω—ã–π –±–ª–æ–∫, –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–û–±—É—á–µ–Ω–∏–µ" ‚Äî "–¢—Ä–µ–Ω–∏–Ω–≥–∏", —Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π –≤ —Å–ø–∏—Å–∫–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã —Å ${date}`,
        footer: `üñá–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –∫–∞–∫–∏–µ-–ª–∏–±–æ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ–±—É—á–µ–Ω–∏—é, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞, –Ω—É–∂–Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏—è, –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–∞–º ‚Äî –≤ –ö–æ–º–∞–Ω–¥—É –ó–∞–±–æ—Ç—ã. –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å —Å 10 –¥–æ 22 –ø–æ –ú–°–ö\n\nüñá–ù–∞–º –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ –∫—É—Ä—Å—É –∏ –Ω–∞—à–µ–π —Ä–∞–±–æ—Ç–µ –≤ —Ü–µ–ª–æ–º. –õ–æ–≥–æ–±–æ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤–∞–º –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∫—É—Ä—Å—É, –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º, –∞ —Ç–∞–∫–∂–µ –µ–∂–µ–º–µ—Å—è—á–Ω—É—é –∞–Ω–∫–µ—Ç—É –æ—Ç–∑—ã–≤–æ–≤ —à–∫–æ–ª—ã –õ–æ–≥–æ–º–∞—à–∏–Ω–∞ —É—á–∏—Ç. –ï—ë –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –∑–∞–ø–æ–ª–Ω—è—Ç—å, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç –Ω–∞—à–µ –æ–±—É—á–µ–Ω–∏–µ –∏ —Ä–∞–±–æ—Ç—É –ª—É—á—à–µ –¥–ª—è –≤–∞—Å\n\n–° –Ω–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ–º –∂–¥–µ–º –≤–∞—Å –Ω–∞ –æ–±—É—á–µ–Ω–∏–∏ üíï\nhttps://get.logomachine.ru/cms/system/login`,
        marketPlaceFooter: `üñá–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –∫–∞–∫–∏–µ-–ª–∏–±–æ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ–±—É—á–µ–Ω–∏—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞, –Ω—É–∂–Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏—è, –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–∞–º ‚Äî –≤ –ö–æ–º–∞–Ω–¥—É –ó–∞–±–æ—Ç—ã. –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å —Å 10 –¥–æ 22 –ø–æ –ú–°–ö\n\n–° –Ω–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ–º –∂–¥–µ–º –≤–∞—Å –Ω–∞ –æ–±—É—á–µ–Ω–∏–∏ üíï\nhttps://get.logomachine.ru/cms/system/login`,
        packagingFooter: `üñá–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –∫–∞–∫–∏–µ-–ª–∏–±–æ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ–±—É—á–µ–Ω–∏—é, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞, –Ω—É–∂–Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏—è, –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–∞–º ‚Äî –≤ –ö–æ–º–∞–Ω–¥—É –ó–∞–±–æ—Ç—ã. –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∂–¥—ã–π –¥–µ–Ω—å —Å 10 –¥–æ 22 –ø–æ –ú–°–ö\n\n–° –Ω–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ–º –∂–¥–µ–º –≤–∞—Å –Ω–∞ –æ–±—É—á–µ–Ω–∏–∏ üíï\nhttps://get.logomachine.ru/cms/system/login`
    };

    function getStreamInfo(isPast, dateObj, streamTime, chatLink, isMotion = false) {
        const dFull = formatDateFull(dateObj);
        const dStream = formatDateStream(dateObj);
        const time = streamTime || '19:00';
        const dDisplay = isMotion ? dStream : dFull;
        if(isPast) return `üñá${dDisplay} –≤ ${time} –ø–æ –ú–°–ö –ø—Ä–æ—à–µ–ª –ø—Ä—è–º–æ–π —ç—Ñ–∏—Ä, –≥–¥–µ –º—ã —Ä–∞—Å—Å–∫–∞–∑–∞–ª–∏ —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ, —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª–∏ —É—á–µ–±–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –ø—Ä—è–º–æ–º —ç—Ñ–∏—Ä–µ. –ó–∞–ø–∏—Å—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —á–∞—Ç–µ.`;
        return `üñá${dDisplay} –≤ ${time} –ø–æ –ú–°–ö –ø—Ä–æ–π–¥–µ—Ç –ø—Ä—è–º–æ–π —ç—Ñ–∏—Ä, –≥–¥–µ –º—ã —Ä–∞—Å—Å–∫–∞–∂–µ–º —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º —É—á–µ–±–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, –æ—Ç–≤–µ—Ç–∏–º –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –ø—Ä—è–º–æ–º —ç—Ñ–∏—Ä–µ, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–π–¥–µ—Ç –≤ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–º —Ç–µ–ª–µ–≥—Ä–∞–º–º-—á–∞—Ç–µ (–æ–Ω –±—É–¥–µ—Ç –∑–∞–ø–∏—Å–∞–Ω –∏ –≤—ã–ª–æ–∂–µ–Ω –≤ —á–∞—Ç ${chatLink || ''})`;
    }

    const GENERATORS = {
        Standard: (config, data) => {
            const { startDate, tariffName, isPast, dates } = data;
            let months, chatLink, fullCourseName;
            let t = null;
            const isGraphStep1 = (data.courseTitle === 'NEW 3.0 –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω' && tariffName === '1 —Å—Ç—É–ø–µ–Ω—å');

            if(config.tariffs) {
                const keys = Object.keys(config.tariffs);
                const key = tariffName || (keys.length > 0 ? keys[0] : null);
                t = config.tariffs[key];
                if(!t) return `‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ç–∞—Ä–∏—Ñ–∞`;
                months = t.months; chatLink = t.chat;
                fullCourseName = isGraphStep1 ? '–ü—Ä–æ—Ñ–µ—Å—Å–∏—è –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω–µ—Ä 1 —Å—Ç—É–ø–µ–Ω—å. –ü–æ—Å–≤—è—â–µ–Ω–∏–µ –≤ –¥–∏–∑–∞–π–Ω.' : `${data.courseTitle} // –¢–∞—Ä–∏—Ñ ${key}`;
            } else {
                months = config.months; chatLink = config.chatLink; fullCourseName = `${data.courseTitle}`;
            }

            const startPhrase = isPast ? `–ú—ã –Ω–∞—á–∞–ª–∏ –æ–±—É—á–µ–Ω–∏–µ (${dates.full})` : `–ú—ã –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–µ (${dates.full})`;
            const startPhraseMotion = isPast ? `–ú—ã –Ω–∞—á–∞–ª–∏ –æ–±—É—á–µ–Ω–∏–µ (–ø–æ—Ç–æ–∫ ${dates.stream})` : `–ú—ã –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–µ (–ø–æ—Ç–æ–∫ ${dates.stream})`;

            let curator = `üñá–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–∞—à–Ω–∏—Ö —Ä–∞–±–æ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ. –ö—É—Ä–∞—Ç–æ—Ä –¥–∞—Å—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –ø–æ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π. –û –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö –∫—É—Ä–∞—Ç–æ—Ä–∞ –±—É–¥–µ—Ç —Å–æ–æ–±—â–∞—Ç—å –õ–æ–≥–æ–±–æ—Ç, –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—É—á–µ–Ω–∏—è.`;
            if(config.isMotion) curator += ` –¢–∞–∫–∂–µ –≤ —á–∞—Ç–µ –∫—É—Ä—Å–∞ –µ—Å—Ç—å –∫—É—Ä–∞—Ç–æ—Ä - ${config.curatorDZ}, –∫ –Ω–µ–π –º–æ–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º...`;
            else if(config.curatorDZ) curator += ` –¢–∞–∫–∂–µ –≤ —á–∞—Ç–µ –∫—É—Ä—Å–∞ –µ—Å—Ç—å –∫—É—Ä–∞—Ç–æ—Ä ${config.curatorDZ}, –∫ –Ω–µ–π –º–æ–∂–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º...`;

            const parts = [];
            let access = (t && t.customAccess) ? t.customAccess : `–Ω–∞ ${config.accessYears} –≥–æ–¥–∞`;
            let accSuff = (access.toLowerCase() === '–Ω–∞–≤—Å–µ–≥–¥–∞') ? '' : ' —Å–æ –¥–Ω—è —Å—Ç–∞—Ä—Ç–∞ –ø–æ—Ç–æ–∫–∞';

            let hLine;
            if(isGraphStep1) hLine = `üñá–£ –≤–∞—Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω –∫—É—Ä—Å "${fullCourseName} –ü–æ—Ç–æ–∫ ${dates.short}", –ø–µ—Ä–∏–æ–¥ –æ–±—É—á–µ–Ω–∏—è –Ω–∞ –Ω–µ–º ${months} ${getMonthText(months)} —Å–æ –¥–Ω—è —Å—Ç–∞—Ä—Ç–∞ –ø–æ—Ç–æ–∫–∞, –¥–æ—Å—Ç—É–ø –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∫—É—Ä—Å–∞ ${access}${accSuff}`;
            else if(config.isMotion) hLine = `ü©∑ –£ –≤–∞—Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω –∫—É—Ä—Å ¬´${data.courseTitle}¬ª // –ü–æ—Ç–æ–∫ ${dates.short} –ø–µ—Ä–∏–æ–¥ –æ–±—É—á–µ–Ω–∏—è –Ω–∞ –Ω–µ–º ${months} ${getMonthText(months)} —Å–æ –¥–Ω—è —Å—Ç–∞—Ä—Ç–∞ –ø–æ—Ç–æ–∫–∞, –¥–æ—Å—Ç—É–ø –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∫—É—Ä—Å–∞ ${access}${accSuff}`;
            else hLine = `üñá–£ –≤–∞—Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω –∫—É—Ä—Å "${fullCourseName} // –ü–æ—Ç–æ–∫ ${dates.short}", –ø–µ—Ä–∏–æ–¥ –æ–±—É—á–µ–Ω–∏—è –Ω–∞ –Ω–µ–º ${months} ${getMonthText(months)} —Å–æ –¥–Ω—è —Å—Ç–∞—Ä—Ç–∞ –ø–æ—Ç–æ–∫–∞, –¥–æ—Å—Ç—É–ø –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –∫—É—Ä—Å–∞ ${access}${accSuff}`;
            parts.push(hLine);

            const sLine = config.isMotion ? `ü©∑ ${startPhraseMotion}` : `üñá${startPhrase}`;
            parts.push(`${sLine}, –∫—É—Ä—Å —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ —É–¥–æ–±–Ω–æ–π –æ–±—É—á–∞—é—â–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ GetCourse... ${!config.isMotion ? chatLink : ''}`);

            if(!config.noStream) parts.push(`${config.isMotion?'ü©∑':''}${getStreamInfo(isPast, startDate, config.streamTime, chatLink, config.isMotion)} ${!isPast && !config.isMotion ? '‚ÄºÔ∏è' : ''}`);

            const bull = config.isMotion ? 'ü©∑' : 'üñá';
            parts.push(`${bull}–°—Å—ã–ª–æ—á–∫–∞ –Ω–∞ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π —á–∞—Ç: ${chatLink} ${!isPast && !config.isMotion ? '‚ÄºÔ∏è' : ''}`);
            parts.push(`${bull}–í–∞–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É —Å—Ç—É–¥–µ–Ω—Ç–∞: ${config.anketa} ${!isPast && !config.isMotion ? '‚ÄºÔ∏è' : ''}`);

            if(!config.isMotion) {
                if(isGraphStep1) parts.push(`üñá–ö—É—Ä—Å –±—É–¥–µ—Ç –≤ —Ä–∞–∑–¥–µ–ª–µ "–û–±—É—á–µ–Ω–∏–µ" ‚Äî "–¢—Ä–µ–Ω–∏–Ω–≥–∏", –¥–æ—Å—Ç—É–ø —Å ${dates.short}`);
                else if(data.courseTitle === 'Digital-–¥–∏–∑–∞–π–Ω–µ—Ä –Ω–æ–≤–æ–π —ç—Ä—ã 3.0') {
                    const action = isPast ? '–æ—Ç–∫—Ä—ã—Ç—ã' : '–æ—Ç–∫—Ä–æ—é—Ç—Å—è';
                    parts.push(`üñá–û–±—É—á–µ–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –º–æ–¥—É–ª—è ¬´–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –±–æ—Ä—Ç¬ª... –û—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –∫—É—Ä—Å–∞ ${action} —Å ${dates.short}`);
                } else parts.push(isPast ? COMMON_TEXT.introBlockPast : COMMON_TEXT.introBlockFuture(dates.short));
            }
            parts.push(config.isMotion ? 'ü©∑ ' + curator.replace(/üñá/g, '') : curator);
            if(data.courseTitle.includes('Digital-–¥–∏–∑–∞–π–Ω–µ—Ä')) parts.push('üñá–í–∞—à–∏ —Ä–∞–±–æ—Ç—ã –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–º–∞–Ω–¥–∞ –∫—É—Ä–∞—Ç–æ—Ä–æ–≤...');
            return parts.join('\n\n');
        },
        NeuroDesign: (config, data) => {
            const { dates } = data;
            return `üíõ –£ –≤–∞—Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω –∫—É—Ä—Å ¬´${data.courseTitle} // ${dates.full}¬ª...\n\n–ü–µ—Ä–µ–¥ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ–º... –≤–≤–æ–¥–Ω—ã–π —É—Ä–æ–∫\nhttps://get.logomachine.ru/pl/teach/control/lesson/view?id=344110695&editMode=0\n\nü©∑ –ö—É—Ä—Å —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ GetCourse...\n\nü©∑ –°—Å—ã–ª–æ—á–∫–∞ –Ω–∞ —á–∞—Ç: ${config.chatLink}\n\nü©∑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–∞—à–Ω–∏—Ö —Ä–∞–±–æ—Ç...`;
        },
        Marketplace: (config, data) => {
            const t = config.tariffs[data.tariffName || Object.keys(config.tariffs)[0]];
            if(!t) return 'Error';
            const df = { start: formatDateDDMMYYYY(data.startDate), end: formatDateDDMMYYYY(calculateEndDate(data.startDate, t.months)), access: formatDateDDMMYYYY(calculateEndDate(data.startDate, 12)) };
            const parts = [];
            if(t.curator) {
                parts.push(`–£ –≤–∞—Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω –∫—É—Ä—Å ${data.courseTitle} ${data.tariffName} ‚Äî –ø–µ—Ä–∏–æ–¥ –æ–±—É—á–µ–Ω–∏—è ${t.months} ${getMonthText(t.months)}, —Å ${df.start} –≥. –¥–æ ${df.end}...`);
                parts.push(`üñá–ö—É—Ä—Å —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ GetCourse...`);
                parts.push(`üñá–°—Å—ã–ª–æ—á–∫–∞ –Ω–∞ —á–∞—Ç: ${t.chat}`);
                parts.push(`üñá–ê–Ω–∫–µ—Ç–∞: ${config.anketa}`);
                parts.push(`üñá–ö—É—Ä—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–û–±—É—á–µ–Ω–∏–µ" ‚Äî "–¢—Ä–µ–Ω–∏–Ω–≥–∏"`);
                parts.push(`üñá–ü—Ä–æ–≤–µ—Ä–∫–∞ –î–ó... –ö—É—Ä–∞—Ç–æ—Ä - ${t.curator}...`);
            } else {
                parts.push(`üñá–£ –≤–∞—Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω –∫—É—Ä—Å "${data.courseTitle} ${data.tariffName}", –¥–æ—Å—Ç—É–ø —Å ${df.start} –ø–æ ${df.access} –≥.`);
                parts.push(`üñá–ö—É—Ä—Å —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ GetCourse...`);
                parts.push(`üñá–°—Å—ã–ª–æ—á–∫–∞ –Ω–∞ —á–∞—Ç: ${t.chat}`);
                parts.push(`üñá–ö—É—Ä—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–û–±—É—á–µ–Ω–∏–µ" ‚Äî "–¢—Ä–µ–Ω–∏–Ω–≥–∏"...`);
            }
            return parts.join('\n\n');
        },
        Packaging: (config, data) => {
            const { isPast, dates } = data;
            const startPhrase = isPast ? `–ú—ã –Ω–∞—á–∞–ª–∏ –æ–±—É—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–µ (${dates.full})` : `–ú—ã –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–µ (${dates.full})`;
            const parts = [];
            parts.push(`üñá–£ –≤–∞—Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω –∫—É—Ä—Å ¬´${data.courseTitle}¬ª // –ü–æ—Ç–æ–∫ ${dates.short}, –ø–µ—Ä–∏–æ–¥ –æ–±—É—á–µ–Ω–∏—è ${config.months} –º–µ—Å—è—Ü–∞...`);
            parts.push(`üñá${startPhrase}, –∫—É—Ä—Å —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ GetCourse...`);
            if(isPast) parts.push(`üñá–ö—É—Ä—Å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–û–±—É—á–µ–Ω–∏–µ¬ª ‚Äî ¬´–¢—Ä–µ–Ω–∏–Ω–≥–∏¬ª`);
            else parts.push(`üñá–ö—É—Ä—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–û–±—É—á–µ–Ω–∏–µ¬ª ‚Äî ¬´–¢—Ä–µ–Ω–∏–Ω–≥–∏¬ª —Å ${dates.short}`);
            parts.push(`üñá–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–∞—à–Ω–∏—Ö —Ä–∞–±–æ—Ç...`);
            return parts.join('\n\n');
        }
    };

    // --- WELCOME EVENTS ---
    const wel = elsWelcome;
    wel.course.addEventListener('change', () => {
        const c = COURSE_CONFIG[wel.course.value];
        wel.tariff.innerHTML = '';
        if(c && c.tariffs) {
            wel.tariffCont.style.display = 'block'; wel.tariff.setAttribute('required','');
            Object.keys(c.tariffs).forEach((n,i) => {
                const opt = document.createElement('option'); opt.value = n;
                opt.textContent = `¬´${n}¬ª` + (c.templateType !== 'Marketplace' ? ` (${c.tariffs[n].months} –º–µ—Å)` : '');
                if(i===0) wel.tariff.value=n;
                if(n===c.defaultTariff) opt.selected=true;
                wel.tariff.appendChild(opt);
            });
        } else { wel.tariffCont.style.display='none'; wel.tariff.removeAttribute('required'); }
    });

    wel.form.addEventListener('submit', (e) => {
        e.preventDefault();
        const conf = COURSE_CONFIG[wel.course.value];
        if(!conf) return;
        const raw = wel.date.value;
        const sd = new Date(raw.replace(/-/g, '/'));
        const today = new Date(); today.setHours(0,0,0,0);
        const isPast = sd < today;
        const dts = { full: formatDateFull(sd), short: formatDateDDMMYYYY(sd), stream: formatDateStream(sd) };
        const gen = GENERATORS[conf.templateType] || GENERATORS.Standard;
        const body = gen(conf, { courseTitle: wel.course.value, tariffName: wel.tariff.value, startDate: sd, isPast, dates: dts });
        
        let foot = COMMON_TEXT.footer;
        if(conf.templateType === 'Packaging') foot = COMMON_TEXT.packagingFooter;
        if(conf.templateType === 'Marketplace') foot = COMMON_TEXT.marketPlaceFooter;

        wel.resultText.value = `${getGreetingTime()}ü©∑ –ù–∞ —Å–≤—è–∑–∏ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–±–æ—Ç—ã –æ—Ç —à–∫–æ–ª—ã –õ–æ–≥–æ–º–∞—à–∏–Ω–∞ —É—á–∏—Ç üíõ\n\n${body}\n\n${foot}`;
        wel.resultBox.classList.add('is-visible');
        wel.copyBtn.style.display = 'flex';
        autoResize(wel.resultText);
        wel.resultBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // --- CALCULATOR EVENTS ---
    document.getElementById('calc-request-date').valueAsDate = new Date();
    
    // New Course
    elsCalc.newCourseSelect.addEventListener('change', () => {
        const val = elsCalc.newCourseSelect.value;
        if(val === 'manual') {
            elsCalc.newCourseManual.style.display = 'block'; elsCalc.newCourseManual.focus();
            elsCalc.newTariffCont.style.display = 'none';
        } else {
            elsCalc.newCourseManual.style.display = 'none';
            const c = COURSE_CONFIG[val];
            elsCalc.newTariff.innerHTML = '';
            if(c && c.tariffs) {
                elsCalc.newTariffCont.style.display = 'block';
                Object.keys(c.tariffs).forEach(n => {
                    const opt = document.createElement('option'); opt.value = n; opt.textContent = n; elsCalc.newTariff.appendChild(opt);
                });
            } else elsCalc.newTariffCont.style.display = 'none';
        }
        calculateLive();
    });
    elsCalc.newTariff.addEventListener('change', calculateLive);

    function calculateLive() {
        const paid = parseFloat(document.getElementById('calc-paid').value) || 0;
        const dur = parseFloat(document.getElementById('calc-duration-months').value) || 12;
        const sDate = document.getElementById('calc-start-date').value;
        const rDate = document.getElementById('calc-request-date').value;
        const nCourseVal = document.getElementById('calc-new-course-name').value;
        const nCourseName = (nCourseVal === 'manual') ? document.getElementById('calc-new-course-manual').value : nCourseVal;
        let nTariff = '';
        if(document.getElementById('calc-new-tariff-container').style.display !== 'none') nTariff = document.getElementById('calc-new-tariff').value;
        
        const nCost = parseFloat(document.getElementById('calc-new-cost').value) || 0;
        const disc = parseFloat(document.getElementById('calc-discount').value) || 0;

        if(!sDate || !rDate) {
            document.getElementById('stat-consumed').textContent = '-';
            document.getElementById('stat-residue').textContent = '-';
            document.getElementById('stat-topay').textContent = '-';
            return;
        }

        const start = new Date(sDate); const req = new Date(rDate);
        start.setHours(0,0,0,0); req.setHours(0,0,0,0);
        
        let days = 0;
        if(start > req) days = 0;
        else days = Math.ceil(Math.abs(req - start) / (1000 * 60 * 60 * 24));

        const totalDays = Math.round(dur * 30.44);
        let priceDay = (totalDays > 0) ? paid / totalDays : 0;
        let consumed = priceDay * days;
        if(consumed > paid) consumed = paid;
        const residue = paid - consumed;
        let toPay = nCost - residue;
        if(toPay < 0) toPay = 0;
        const discAmt = toPay * (disc / 100);
        const finalPay = Math.round(toPay - discAmt);

        const fmt = (n) => Math.round(n).toLocaleString('ru-RU');
        document.getElementById('stat-consumed').textContent = fmt(consumed) + ' ‚ÇΩ';
        document.getElementById('stat-residue').textContent = fmt(residue) + ' ‚ÇΩ';
        document.getElementById('stat-topay').textContent = fmt(finalPay) + ' ‚ÇΩ';

        const pct = totalDays > 0 ? (days / totalDays) * 100 : 0;
        document.getElementById('progress-fill').style.width = `${Math.min(Math.max(pct,0),100)}%`;
        document.getElementById('prog-days-studied').textContent = `${days} –¥–Ω. –ø—Ä–æ–π–¥–µ–Ω–æ`;
        document.getElementById('prog-days-total').textContent = `–í—Å–µ–≥–æ ${totalDays} –¥–Ω.`;

        const inst = (m) => Math.round(toPay / m).toLocaleString('ru-RU');
        const fullNewName = nTariff ? `${nCourseName} (${nTariff})` : (nCourseName || '...');

        const txt = `–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞ –∫—É—Ä—Å ${fullNewName} —Å–æ—Å—Ç–∞–≤–∏—Ç —Ä.${fmt(toPay)}
–í–æ–∑–º–æ–∂–Ω–∞ –±–µ—Å–ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Ä–∞—Å—Å—Ä–æ—á–∫–∞ –≤ –±–∞–Ω–∫–µ:¬†
–Ω–∞ 6 –º–µ—Å—è—Ü–µ–≤ ‚Äî ${inst(6)} —Ä./–º–µ—Å.
–Ω–∞ 12 –º–µ—Å—è—Ü–µ–≤ ‚Äî ${inst(12)} —Ä./–º–µ—Å.
–Ω–∞ 24 –º–µ—Å—è—Ü–∞ ‚Äî ${inst(24)} —Ä./–º–µ—Å.
–Ω–∞ 36 –º–µ—Å—è—Ü–µ–≤ ‚Äî ${inst(36)} —Ä./–º–µ—Å.

–ê –ø—Ä–∏ –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ–π –æ–ø–ª–∞—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞ –æ—Ç –ö–æ–º–∞–Ω–¥—ã –∑–∞–±–æ—Ç—ã -${disc}%üî•
–°—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç —Å–æ—Å—Ç–∞–≤–∏—Ç—å: ${fmt(finalPay)} —Ä.`;

        const resTxt = document.getElementById('result-text-calc');
        resTxt.value = txt;
        autoResize(resTxt);
    }

    const calcInputs = document.querySelectorAll('#calculator-form input, #calculator-form select');
    calcInputs.forEach(i => {
        i.addEventListener('input', calculateLive);
        i.addEventListener('change', calculateLive);
    });

</script>
</body>
</html>
